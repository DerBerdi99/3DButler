{% extends 'base.html' %}

{% block title %}Admin - Projekt Review{% endblock %}

{% block header %}
<style>
/* CSS fÃ¼r den Status-Header */

/* NEUE CSS-DEFINITIONEN FÃœR DEN CHAT (Aus Kunden-Template Ã¼bernommen) */
.message-container {
    max-height: 500px;
    overflow-y: auto;
    background-color: #f8f9fa; /* Hellgrauer Hintergrund fÃ¼r den Chat */
    padding: 15px;
    border-radius: 8px;
}
.message-bubble {
    max-width: 80%;
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 18px;
    line-height: 1.4;
    word-wrap: break-word;
}
/* Kunden-Nachricht (Admin sieht sie links, hellgrau) */
.admin-message {
    background-color: #e2e6ea; /* Hellgrau fÃ¼r Admin im Kunden-Template */
    color: #212529;
    margin-right: auto;
    border-bottom-left-radius: 4px;
}
/* Admin-Nachricht (Admin sieht sie rechts, dunkelblau) */
.user-message {
    background-color: #370987; /* Dunkelblau fÃ¼r User im Kunden-Template */
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}
.timestamp {
    font-size: 10px;
    margin-top: 3px;
    opacity: 0.7;
}

/* Entfernt die Border vom Chat-Container, da .message-container padding/radius hat */
.card-body.p-0 > .message-container {
    border: none !important;
}
</style>
{% endblock %}

{% block body %}
<div class="container text-center content-shift">
    <h1 class="mb-4 text-primary">Admin Review Page</h1>

    <!-- Navigation (UnverÃ¤ndert Ã¼bernommen) -->
    <div class="row justify-content-center" style="margin: 10px;">
      <div class="col-md-6">
        <div class="list-group">
            <a href="{{ url_for('views.shop') }}" class="list-group-item list-group-item-action">
                <i class="products-plates" aria-hidden="true"></i>
                <span class="link-name">Zum Shop (Kundenansicht)</span>
            </a>
            <a href="{{ url_for('admin_views.review_projects') }}" class="list-group-item list-group-item-action list-group-item-warning">
                <i class="products-palisades" aria-hidden="true"></i>
                <span class="link-name">PROJEKTE BEGUTACHTEN (Review-Queue)</span>
            </a>
            <a href="{{ url_for('admin_views.user_management') }}" class="list-group-item list-group-item-action">
                <i class="products-parking"></i>
                <span class="link-name">Benutzerverwaltung</span>
            </a>
        </div>
      </div>
    </div>

    <!-- Projekt-Informationen (UnverÃ¤ndert Ã¼bernommen) -->
    <div class="container mt-4">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <strong>Projekt:</strong> {{ project.ProjectName }}
            </div>
            <div class="card-body text-left">
                <strong>Kunden User ID:</strong> {{ project.UserID }}
            </div>
            <div class="card-body text-left">
                <strong>Arbeitsaufwand:</strong> {{ project.MaterialType }}
            </div>
            <div class="card-body text-left">
                <p><strong>Status:</strong> <span class="badge bg-warning">{{ project.Status | replace('_', ' ') }}</span></p>
                <p><strong>Beschreibung:</strong> {{ project.ProjectDescription }}</p>
            </div>
        </div>
    </div>

    <!-- NEUE ZWEISPALTRIGE ANSICHT: Chat & Admin-Aktionen -->
    <div class="container mt-4">
        <div class="row">

            <!-- Linke Spalte: Projekt-Chat -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">

                        Projekt-Kommunikation
                    </div>

                    <div class="card-body p-0">
                        <div class="message-container" id="chat-messages">

                            <!-- Jinja2-Schleife zur Anzeige der Nachrichten aus der SQLite-DB (Angepasst) -->
                            {% if messages %}
                                {% for message in messages %}
                                    {% set is_admin = message.SenderType == 'Admin' %}

                                    <!-- Flex-Container fÃ¼r die Ausrichtung -->
                                    <div class="d-flex {{ 'justify-content-end' if is_admin else 'justify-content-start' }}">
                                        <!-- message-bubble mit korrekten Farben/Ausrichtung -->
                                        <div class="message-bubble {{ 'user-message' if is_admin else 'admin-message' }} shadow-sm">
                                            {{ message.MessageText }}
                                            <div class="timestamp {{ 'text-white' if is_admin else 'text-dark' }}">
                                                {{ 'Sie (Admin)' if is_admin else 'Kunde' }} - {{ message.Timestamp | default('Datum N/A') }}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted p-5">
                                    <h1>ðŸ“ª</h1>
                                    <br>
                                    <h5>Noch keine Nachrichten in diesem Projekt.</h5>
                                </div>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>

            <!-- Rechte Spalte: Admin Action Formular -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-danger text-white">
                        1. Review & Status-Aktionen
                    </div>

                    <div class="card-body">

                        <!-- Das Formular sendet alle Daten (Nachricht + Checkboxen) an die Flask-Route -->
                        <form method="POST" action="{{ url_for('admin_views.admin_send_review', project_id=project.ProjectID) }}">

                            <!-- Neues Nachrichtenfeld fÃ¼r den Chat -->
                            <div class="mb-3">
                                <label for="message_text" class="form-label">Nachricht an Kunden (Preisvorschlag/RÃ¼ckfrage):</label>
                                <textarea class="form-control" id="message_text" name="message_text" rows="3" required></textarea>
                            </div>

                            <hr class="my-4">

                            <!-- NEUER KONTROLLBLOCK FÃœR PERSISTENTEN DATEI-UPLOAD-STATUS -->
                            {% if messages.RequiredFilesProvided %}
                            <!-- Fall: Dateien wurden erfolgreich hochgeladen und der Status ist persistent -->
                            <div class="mb-4 p-3 border border-success bg-light-green rounded text-success">
                                <h5 class="mb-0">
                                    ZUSÃ„TZLICHE DOKUMENTE VORHANDEN
                                </h5>
                                <small class="d-block">Der Kunde hat die nachgeforderten Unterlagen erfolgreich bereitgestellt.</small>
                            </div>
                            <!-- Wichtig: Die Checkbox wird in diesem Fall nicht angezeigt -->
                            {% else %}
                            <!-- Fall: Checkbox anzeigen, um Dokumente anzufordern -->
                            <div class="form-check mb-3 p-3 border border-warning rounded">
                                <input class="form-check-input" type="checkbox" name="request_documents" id="request_documents">
                                <label class="form-check-label text-warning" for="request_documents">
                                    <strong>ZUSÃ„TZLICHE DOKUMENTE ANFORDERN</strong>
                                </label>
                                <small class="form-text text-muted d-block">Setzt den Status auf "REQUIRES_FILES" und informiert den Kunden Ã¼ber fehlende Unterlagen.</small>
                            </div>
                            {% endif %}
                            <!-- ENDE NEUER KONTROLLBLOCK -->

                            <!-- Review 1 Ã¼berspringen (StandardmÃ¤ÃŸig Opt-Out) -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" name="skip_review_1" id="skip_review_1">
                                <label class="form-check-label" for="skip_review_1">
                                    <strong>Review 1 Ã¼berspringen</strong> (Direkt zur finalen PrÃ¼fung)
                                </label>
                                <small class="form-text text-muted d-block">Setzt den Status direkt auf 'WAITING_FOR_QUOTE'.</small>
                            </div>

                            <!-- Absende-Button -->
                            <button type="submit" class="btn btn-danger w-100"
                                {% if project.Status != 'PROJECT_COMPLETED' and project.Status != 'UNDER_REVIEW' and project.Status != 'WAITING_FOR_QUOTE' %} disabled {% endif %}>
                                Nachricht senden & Aktionen speichern
                            </button>

                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Stellt sicher, dass das Chatfenster beim Laden automatisch nach unten scrollt
    document.addEventListener('DOMContentLoaded', function() {
        const chatWindow = document.getElementById('chat-messages');
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    });
</script>

{% endblock %}